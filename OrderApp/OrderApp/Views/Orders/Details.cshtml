@model OrderApp.Models.Order
@{
    ViewData["Title"] = $"Detalle Pedido #{Model.Id}";
    bool canManage = User.IsInRole("Admin") || User.IsInRole("Empleado");
}

<h2>Pedido #@Model.Id</h2>

@if (TempData["Error"] != null)
{
    <div class="alert alert-danger">@TempData["Error"]</div>
}
@if (TempData["Success"] != null)
{
    <div class="alert alert-success">@TempData["Success"]</div>
}

<div class="card mb-3">
    <div class="card-body">
        <p><b>Cliente:</b> @Model.User?.Name (@Model.UserId)</p>
        <p><b>Fecha:</b> @Model.CreatedAt.ToLocalTime()</p>
        <p><b>Estado:</b> <span class="badge bg-secondary">@Model.Status</span></p>
        <p class="mb-0">
            <b>Subtotal:</b> @Model.Subtotal
            &nbsp;|&nbsp; <b>Impuestos:</b> @Model.Tax
            &nbsp;|&nbsp; <b>Total:</b> @Model.Total
        </p>
    </div>
</div>

<h4>Productos</h4>
<table class="table table-striped align-middle">
    <thead>
        <tr>
            <th>Producto</th>
            <th style="width:120px;">Cantidad</th>
            <th style="width:140px;">Precio</th>
            <th style="width:160px;">Subtotal</th>
        </tr>
    </thead>
    <tbody>
        @foreach (var i in Model.Items)
        {
            <tr>
                <td>@i.Product?.Name</td>
                <td>@i.Quantity</td>
                <td>@i.UnitPrice</td>
                <td>@(i.UnitPrice* i.Quantity)</td>
            </tr>
        }
    </tbody>
</table>

@if (canManage)
{
    <div class="mt-4">
        <form asp-action="ChangeStatus" method="post" class="row g-2 align-items-center" style="max-width:520px;">
            @Html.AntiForgeryToken()
            <input type="hidden" name="id" value="@Model.Id" />
            <div class="col-auto">
                <label class="col-form-label"><b>Cambiar estado:</b></label>
            </div>
            <div class="col">
                <select name="status" class="form-select">
                    <option value="Pending" selected="@("Pending" == Model.Status)">Pendiente</option>
                    <option value="Processed" selected="@("Processed" == Model.Status)">Procesado</option>
                    <option value="Shipped" selected="@("Shipped" == Model.Status)">Enviado</option>
                    <option value="Delivered" selected="@("Delivered" == Model.Status)">Entregado</option>
                </select>
            </div>
            <div class="col-auto">
                <button type="submit" class="btn btn-warning">Cambiar estado</button>
            </div>
        </form>
    </div>
}

<div class="mt-4">
    <a asp-action="Index" class="btn btn-secondary">Volver a la lista</a>
</div>
